<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Scott's Broadcast Tracker</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --navy: #00263A; --navy-mid: #003a56;
    --gold: #C8A84B; --gold-light: #e8c86b;
    --cream: #F9F6EF; --cream-dark: #EDE9DF;
    --gray: #8A8A8A; --red: #C0392B; --green: #1a8a5a;
    --card-shadow: 0 4px 24px rgba(0,38,58,0.10);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Syne', sans-serif; background: var(--cream); color: var(--navy); min-height: 100vh; padding-bottom: 120px; }

  /* HEADER */
  header { background: var(--navy); padding: 18px 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
  .header-top { display: flex; align-items: flex-start; justify-content: space-between; padding-bottom: 10px; }
  header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; color: var(--gold); }
  header p  { font-family: 'DM Mono', monospace; font-size: 10px; color: rgba(249,246,239,0.5); margin-top: 2px; }
  .header-stats { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
  .stat-pill { background: rgba(255,255,255,0.08); border: 1px solid rgba(200,168,75,0.3); border-radius: 20px; padding: 4px 10px; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--cream); white-space: nowrap; }
  .stat-pill span { color: var(--gold-light); font-weight: 500; }

  /* SYNC BAR */
  .sync-bar { display: flex; align-items: center; justify-content: space-between; padding: 5px 0 10px; }
  .sync-status { font-family: 'DM Mono', monospace; font-size: 10px; display: flex; align-items: center; gap: 5px; }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--gray); flex-shrink: 0; transition: background 0.3s; }
  .sync-dot.synced  { background: #2ecc71; }
  .sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
  .sync-dot.error   { background: var(--red); }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
  .sync-text { color: rgba(249,246,239,0.6); }
  .btn-sync-now { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gold); background: rgba(200,168,75,0.15); border: 1px solid rgba(200,168,75,0.3); border-radius: 10px; padding: 3px 10px; cursor: pointer; }

  /* TABS */
  .tab-nav { display: flex; }
  .tab-btn { flex: 1; padding: 10px 4px; background: transparent; border: none; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; color: rgba(249,246,239,0.4); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }

  main { padding: 16px; max-width: 480px; margin: 0 auto; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* FORM CARD */
  .form-card { background: white; border-radius: 16px; padding: 18px; box-shadow: var(--card-shadow); margin-bottom: 18px; border: 1px solid var(--cream-dark); }
  .form-card h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--navy); margin-bottom: 14px; padding-bottom: 10px; border-bottom: 2px solid var(--gold); display: inline-block; }
  .field { margin-bottom: 12px; }
  label { display: block; font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom: 4px; }
  input, select, textarea { width: 100%; padding: 10px 13px; border: 1.5px solid var(--cream-dark); border-radius: 10px; font-family: 'Syne', sans-serif; font-size: 15px; color: var(--navy); background: var(--cream); transition: border-color 0.2s, box-shadow 0.2s; -webkit-appearance: none; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(200,168,75,0.15); background: white; }
  textarea { resize: none; height: 60px; font-size: 14px; }
  .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* CALC DISPLAYS */
  .calc-display { background: var(--navy); border-radius: 10px; padding: 11px 14px; display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
  .calc-display .main-val { font-family: 'DM Mono', monospace; font-size: 20px; font-weight: 500; color: var(--gold); }
  .calc-display .sub-info { font-family: 'DM Mono', monospace; font-size: 11px; color: rgba(249,246,239,0.6); text-align: right; }
  .calc-display .sub-info .accent { font-size: 13px; color: var(--gold-light); font-weight: 500; margin-top: 2px; }
  .helper-note { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray); margin-top: 5px; text-align: center; }

  /* RECEIPT UPLOAD */
  .receipt-upload-area { border: 2px dashed var(--cream-dark); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; position: relative; }
  .receipt-upload-area:hover { border-color: var(--gold); background: rgba(200,168,75,0.05); }
  .receipt-upload-area input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; padding: 0; border: none; background: none; }
  .upload-icon { font-size: 24px; margin-bottom: 6px; }
  .upload-text { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--gray); }
  .upload-text strong { color: var(--navy); }
  .receipt-preview { margin-top: 10px; position: relative; display: inline-block; }
  .receipt-preview img { max-width: 100%; max-height: 160px; border-radius: 10px; border: 2px solid var(--cream-dark); display: block; }
  .receipt-preview .remove-receipt { position: absolute; top: -8px; right: -8px; background: var(--red); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }

  /* BUTTONS */
  .btn-add { width: 100%; padding: 13px; background: var(--navy); color: var(--gold); border: none; border-radius: 12px; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s, transform 0.1s; margin-top: 4px; }
  .btn-add:active { transform: scale(0.98); background: var(--navy-mid); }
  .btn-export { width: 100%; padding: 12px; background: transparent; color: var(--navy); border: 2px solid var(--navy); border-radius: 12px; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; }
  .btn-export:active { background: var(--navy); color: var(--gold); }
  .btn-backup { width: 100%; padding: 12px; background: var(--gold); color: var(--navy); border: none; border-radius: 12px; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; }
  .btn-backup:active { background: var(--gold-light); }

  /* SECTION / FILTERS */
  .section-title { font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; color: var(--gray); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
  .section-title button { background: none; border: 1px solid var(--cream-dark); border-radius: 6px; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray); padding: 3px 8px; cursor: pointer; }
  .filter-tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
  .filter-tab { flex-shrink: 0; padding: 5px 13px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 11px; border: 1.5px solid var(--cream-dark); background: white; color: var(--gray); cursor: pointer; transition: all 0.15s; }
  .filter-tab.active { background: var(--navy); color: var(--gold); border-color: var(--navy); }

  /* ENTRY CARDS */
  .entry-card { background: white; border-radius: 14px; padding: 13px 15px; margin-bottom: 9px; box-shadow: 0 2px 10px rgba(0,38,58,0.06); border: 1px solid var(--cream-dark); display: flex; gap: 11px; align-items: flex-start; animation: slideIn 0.25s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);} }
  .entry-dot { width: 34px; height: 34px; border-radius: 10px; background: var(--navy); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 15px; }
  .entry-body { flex: 1; min-width: 0; }
  .entry-desc { font-size: 13px; font-weight: 600; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .entry-meta { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gray); margin-top: 3px; }
  .entry-badges { margin-top: 4px; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
  .entry-note { font-size: 11px; color: var(--gray); margin-top: 3px; font-style: italic; }
  .entry-right { text-align: right; flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
  .entry-main-val { font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 500; color: var(--navy); }
  .entry-sub-val { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--green); }
  .entry-delete { background: none; border: none; color: var(--cream-dark); font-size: 15px; cursor: pointer; padding: 2px 4px; margin-left: 4px; border-radius: 4px; transition: color 0.15s; flex-shrink: 0; align-self: center; }
  .entry-delete:hover { color: var(--red); }

  /* RECEIPT */
  .receipt-thumb { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; border: 1.5px solid var(--cream-dark); cursor: pointer; transition: transform 0.15s; }
  .receipt-thumb:hover { transform: scale(1.05); }
  .no-receipt { width: 36px; height: 36px; border-radius: 8px; border: 1.5px dashed var(--cream-dark); display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--cream-dark); }

  /* LIGHTBOX */
  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; align-items: center; justify-content: center; padding: 20px; }
  .lightbox.open { display: flex; }
  .lightbox img { max-width: 100%; max-height: 85vh; border-radius: 12px; }
  .lightbox-close { position: absolute; top: 16px; right: 16px; background: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* BADGES */
  .cat-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500; }
  .cat-meals{background:#FFE8CC;color:#7a3e00;} .cat-transport{background:#D1ECE8;color:#0c5e4e;} .cat-lodging{background:#E0D7F5;color:#3a1e7a;} .cat-equipment{background:#D6EAF8;color:#1a4a7a;} .cat-other{background:#E8E8F0;color:#4a4a6a;}
  .sport-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 10px; font-weight: 500; }
  .sport-basketball{background:#FFF3CD;color:#856404;} .sport-football{background:#D1ECE8;color:#0c5e4e;} .sport-other{background:#E8E8F0;color:#4a4a6a;}
  .status-badge { display: inline-block; padding: 2px 7px; border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 9px; font-weight: 500; cursor: pointer; user-select: none; }
  .status-invoiced{background:#D4EDDA;color:#155724;} .status-pending{background:#FFF3CD;color:#856404;} .status-paid{background:#CCE5FF;color:#004085;}

  /* LOADING OVERLAY */
  .loading-overlay { position: fixed; inset: 0; background: var(--navy); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; transition: opacity 0.4s; }
  .loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .loading-logo { font-size: 28px; font-weight: 800; color: var(--gold); font-family: 'Syne', sans-serif; margin-bottom: 8px; }
  .loading-sub { font-family: 'DM Mono', monospace; font-size: 11px; color: rgba(249,246,239,0.5); margin-bottom: 28px; }
  .loading-spinner { width: 32px; height: 32px; border: 3px solid rgba(200,168,75,0.2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }


  /* SETUP SCREEN */
  .setup-screen { position: fixed; inset: 0; background: var(--navy); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
  .setup-screen.hidden { display: none; }
  .setup-logo { font-size: 28px; font-weight: 800; color: var(--gold); font-family: 'Syne', sans-serif; margin-bottom: 6px; }
  .setup-sub { font-family: 'DM Mono', monospace; font-size: 11px; color: rgba(249,246,239,0.4); margin-bottom: 36px; letter-spacing: 1px; }
  .setup-card { background: white; border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; }
  .setup-card h2 { font-size: 16px; font-weight: 800; color: var(--navy); margin-bottom: 6px; }
  .setup-card p { font-size: 12px; color: var(--gray); line-height: 1.7; margin-bottom: 18px; }
  .setup-field { margin-bottom: 14px; }
  .setup-field label { display: block; font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom: 5px; }
  .setup-field input { width: 100%; padding: 10px 13px; border: 1.5px solid var(--cream-dark); border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--navy); background: var(--cream); }
  .setup-field input:focus { outline: none; border-color: var(--gold); background: white; }
  .btn-setup { width: 100%; padding: 13px; background: var(--navy); color: var(--gold); border: none; border-radius: 12px; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 4px; }
  .setup-error { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--red); text-align: center; margin-top: 10px; min-height: 16px; }
  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 36px 20px; color: var(--gray); }
  .empty-state .icon { font-size: 34px; margin-bottom: 10px; }
  .empty-state p { font-size: 13px; line-height: 1.6; }

  /* TOAST */
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--navy); color: var(--gold); padding: 11px 22px; border-radius: 30px; font-family: 'DM Mono', monospace; font-size: 12px; z-index: 1000; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- Loading screen -->

<!-- Setup screen -->
<div class="setup-screen" id="setup-screen">
  <div class="setup-logo">Broadcast Tracker</div>
  <div class="setup-sub">SCOTT GARRARD ¬∑ AGGIE SPORTS PROPERTIES</div>
  <div class="setup-card">
    <h2>Connect to Airtable</h2>
    <p>Enter your Airtable credentials once and they'll be saved privately on this device.</p>
    <div class="setup-field">
      <label>Base ID</label>
      <input type="text" id="setup-base" placeholder="appXXXXXXXXXXXXXX">
    </div>
    <div class="setup-field">
      <label>Personal Access Token</label>
      <input type="text" id="setup-token" placeholder="patXXXXXX.XXXXXXXX">
    </div>
    <button class="btn-setup" onclick="saveSetup()">Connect & Launch ‚Üí</button>
    <div class="setup-error" id="setup-error"></div>
  </div>
</div>

<div class="loading-overlay" id="loading-overlay">
  <div class="loading-logo">Broadcast Tracker</div>
  <div class="loading-sub">SYNCING WITH AIRTABLE...</div>
  <div class="loading-spinner"></div>
</div>

<header>
  <div class="header-top">
    <div>
      <h1>Broadcast Tracker</h1>
      <p>SCOTT GARRARD ¬∑ AGGIE SPORTS PROPERTIES</p>
    </div>
    <div class="header-stats">
      <div class="stat-pill">Miles: <span id="ytd-miles">0</span></div>
      <div class="stat-pill">Events: <span id="ytd-events">0</span></div>
      <div class="stat-pill">Expenses: <span id="ytd-expenses">$0</span></div>
    </div>
  </div>
  <div class="sync-bar">
    <div class="sync-status">
      <div class="sync-dot" id="sync-dot"></div>
      <span class="sync-text" id="sync-text">Connecting...</span>
    </div>
    <button class="btn-sync-now" onclick="syncAll()">‚Üª Sync Now</button>
  </div>
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('mileage',this)">üöó Mileage</button>
    <button class="tab-btn"        onclick="switchTab('events',this)">üéôÔ∏è Events</button>
    <button class="tab-btn"        onclick="switchTab('expenses',this)">üßæ Expenses</button>
  </div>
</header>

<main>

  <!-- ‚ïê‚ïê MILEAGE TAB ‚ïê‚ïê -->
  <div class="tab-panel active" id="tab-mileage">
    <div class="form-card">
      <h2>Log a Trip</h2>
      <div class="field"><label>Date</label><input type="date" id="trip-date"></div>
      <div class="field"><label>Description / Event</label><input type="text" id="trip-desc" placeholder="e.g. USU vs Boise State ‚Äî Logan to Boise"></div>
      <div class="row-2">
        <div class="field"><label>Start Odometer</label><input type="number" id="start-odo" placeholder="42100" inputmode="numeric"></div>
        <div class="field"><label>End Odometer</label><input type="number" id="end-odo" placeholder="42380" inputmode="numeric"></div>
      </div>
      <div class="field"><label>‚Äî or enter miles directly ‚Äî</label><input type="number" id="direct-miles" placeholder="e.g. 280" inputmode="numeric"></div>
      <div class="calc-display">
        <div class="main-val"><span id="calc-miles">0</span> mi</div>
        <div class="sub-info">IRS Rate: $<span id="irs-rate-display">0.700</span>/mi<div class="accent">= $<span id="calc-amount">0.00</span></div></div>
      </div>
      <p class="helper-note">2026 IRS standard rate (70¬¢/mi)</p>
      <div class="field" style="margin-top:11px;"><label>Notes (optional)</label><textarea id="trip-note" placeholder="Tolls, parking, purpose, etc."></textarea></div>
      <button class="btn-add" onclick="addMileage()">+ Log Trip</button>
    </div>
    <div class="section-title"><span>Trip Log</span><button onclick="exportMileageCSV()">Export CSV</button></div>
    <div class="filter-tabs" id="mileage-filters">
      <div class="filter-tab active" onclick="setMileageFilter('all',this)">All</div>
      <div class="filter-tab" onclick="setMileageFilter('2026',this)">2026</div>
      <div class="filter-tab" onclick="setMileageFilter('2025',this)">2025</div>
    </div>
    <div id="mileage-list"></div>
    <button class="btn-export" onclick="exportMileageCSV()">‚¨á Export Mileage CSV</button>
    <button class="btn-backup" onclick="exportAllCSV()">üíæ Backup All Data</button>
  </div>

  <!-- ‚ïê‚ïê EVENTS TAB ‚ïê‚ïê -->
  <div class="tab-panel" id="tab-events">
    <div class="form-card">
      <h2>Log an Event</h2>
      <div class="row-2">
        <div class="field"><label>Date</label><input type="date" id="event-date"></div>
        <div class="field"><label>Sport</label>
          <select id="event-sport"><option value="Basketball">üèÄ Basketball</option><option value="Football">üèà Football</option><option value="Other">üéôÔ∏è Other</option></select>
        </div>
      </div>
      <div class="field"><label>Home Team</label><input type="text" id="event-home" placeholder="e.g. Utah State"></div>
      <div class="field"><label>Opponent</label><input type="text" id="event-opponent" placeholder="e.g. Boise State"></div>
      <div class="field"><label>Venue / Location</label><input type="text" id="event-venue" placeholder="e.g. Dee Glen Smith Spectrum"></div>
      <div class="row-2">
        <div class="field"><label>Pay ($)</label><input type="number" id="event-pay" placeholder="515.00" inputmode="decimal" oninput="updatePayDisplay()"></div>
        <div class="field"><label>Payment Status</label>
          <select id="event-status"><option value="pending">Pending</option><option value="invoiced">Invoiced</option><option value="paid">Paid</option></select>
        </div>
      </div>
      <div class="calc-display"><div class="sub-info" style="text-align:left;">Event Pay</div><div class="main-val">$<span id="display-pay">0.00</span></div></div>
      <div class="field" style="margin-top:11px;"><label>Notes (optional)</label><textarea id="event-note" placeholder="Broadcast partner, notes, details..."></textarea></div>
      <button class="btn-add" onclick="addEvent()">+ Log Event</button>
    </div>
    <div class="section-title"><span>Event Log</span><button onclick="exportEventsCSV()">Export CSV</button></div>
    <div class="filter-tabs" id="event-filters">
      <div class="filter-tab active" onclick="setEventFilter('all',this)">All</div>
      <div class="filter-tab" onclick="setEventFilter('2026',this)">2026</div>
      <div class="filter-tab" onclick="setEventFilter('2025',this)">2025</div>
      <div class="filter-tab" onclick="setEventFilter('Basketball',this)">üèÄ</div>
      <div class="filter-tab" onclick="setEventFilter('Football',this)">üèà</div>
      <div class="filter-tab" onclick="setEventFilter('pending',this)">Pending</div>
      <div class="filter-tab" onclick="setEventFilter('paid',this)">Paid</div>
    </div>
    <div id="events-list"></div>
    <button class="btn-export" onclick="exportEventsCSV()">‚¨á Export Events CSV</button>
    <button class="btn-backup" onclick="exportAllCSV()">üíæ Backup All Data</button>
  </div>

  <!-- ‚ïê‚ïê EXPENSES TAB ‚ïê‚ïê -->
  <div class="tab-panel" id="tab-expenses">
    <div class="form-card">
      <h2>Log an Expense</h2>
      <div class="row-2">
        <div class="field"><label>Date</label><input type="date" id="exp-date"></div>
        <div class="field"><label>Category</label>
          <select id="exp-category"><option value="meals">üçî Meals</option><option value="transport">üöï Transport</option><option value="lodging">üè® Lodging</option><option value="equipment">üéß Equipment</option><option value="other">üìé Other</option></select>
        </div>
      </div>
      <div class="field"><label>Description</label><input type="text" id="exp-desc" placeholder="e.g. Dinner after USU vs Nevada"></div>
      <div class="row-2">
        <div class="field"><label>Amount ($)</label><input type="number" id="exp-amount" placeholder="0.00" inputmode="decimal" oninput="updateExpDisplay()"></div>
        <div class="field"><label>Vendor</label><input type="text" id="exp-vendor" placeholder="e.g. Uber, Chili's"></div>
      </div>
      <div class="calc-display"><div class="sub-info" style="text-align:left;">Expense Total</div><div class="main-val">$<span id="display-exp">0.00</span></div></div>
      <div class="field" style="margin-top:12px;">
        <label>Receipt Photo (optional)</label>
        <div class="receipt-upload-area" id="upload-area">
          <input type="file" id="receipt-input" accept="image/*" capture="environment" onchange="handleReceiptUpload(event)">
          <div class="upload-icon">üì∑</div>
          <div class="upload-text"><strong>Take a photo or upload</strong><br>Tap to capture receipt</div>
        </div>
        <div id="receipt-preview-container"></div>
      </div>
      <div class="field"><label>Notes (optional)</label><textarea id="exp-note" placeholder="Event name, who attended, purpose..."></textarea></div>
      <button class="btn-add" onclick="addExpense()">+ Log Expense</button>
    </div>
    <div class="section-title"><span>Expense Log</span><button onclick="exportExpensesCSV()">Export CSV</button></div>
    <div class="filter-tabs" id="expense-filters">
      <div class="filter-tab active" onclick="setExpenseFilter('all',this)">All</div>
      <div class="filter-tab" onclick="setExpenseFilter('2026',this)">2026</div>
      <div class="filter-tab" onclick="setExpenseFilter('2025',this)">2025</div>
      <div class="filter-tab" onclick="setExpenseFilter('meals',this)">üçî</div>
      <div class="filter-tab" onclick="setExpenseFilter('transport',this)">üöï</div>
      <div class="filter-tab" onclick="setExpenseFilter('lodging',this)">üè®</div>
      <div class="filter-tab" onclick="setExpenseFilter('equipment',this)">üéß</div>
    </div>
    <div id="expenses-list"></div>
    <button class="btn-export" onclick="exportExpensesCSV()">‚¨á Export Expenses CSV</button>
    <button class="btn-backup" onclick="exportAllCSV()">üíæ Backup All Data</button>
  </div>

</main>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <img id="lightbox-img" src="" alt="Receipt">
</div>
<div class="toast" id="toast"></div>

<script>

  // ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function checkSetup() {
    const base  = localStorage.getItem('at_base');
    const token = localStorage.getItem('at_token');
    if (!base || !token) {
      document.getElementById('setup-screen').classList.remove('hidden');
      document.getElementById('loading-overlay').style.display = 'none';
      return false;
    }
    return true;
  }

  function saveSetup() {
    const base  = document.getElementById('setup-base').value.trim();
    const token = document.getElementById('setup-token').value.trim();
    const err   = document.getElementById('setup-error');
    if (!base.startsWith('app')) { err.textContent = 'Base ID should start with "app"'; return; }
    if (!token.startsWith('pat')) { err.textContent = 'Token should start with "pat"'; return; }
    try {
      localStorage.setItem('at_base', base);
      localStorage.setItem('at_token', token);
      // Verify it saved
      const saved = localStorage.getItem('at_base');
      if (saved) {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('loading-overlay').style.display = 'flex';
        renderMileage(); renderEvents(); renderExpenses(); updateStats();
        syncAll();
      } else {
        err.textContent = 'Could not save ‚Äî try a different browser';
      }
    } catch(e) {
      err.textContent = 'Storage blocked ‚Äî try Chrome or Safari';
    }
  }

  // ‚îÄ‚îÄ AIRTABLE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const AT_BASE  = localStorage.getItem('at_base') || '';
  const AT_TOKEN = localStorage.getItem('at_token') || '';
  function getUrl() { return `https://api.airtable.com/v0/${localStorage.getItem('at_base')||''}`; }
  function getHeaders() { return { 'Authorization': `Bearer ${localStorage.getItem('at_token')||''}`, 'Content-Type': 'application/json' }; }

  const IRS_RATE = 0.70;
  let mileageEntries = JSON.parse(localStorage.getItem('mileage_entries') || '[]');
  let eventEntries   = JSON.parse(localStorage.getItem('event_entries')   || '[]');
  let expenseEntries = JSON.parse(localStorage.getItem('expense_entries') || '[]');
  let mileageFilter = 'all', eventFilter = 'all', expenseFilter = 'all';
  let pendingReceipt = null;
  let syncTimer = null;

  ['trip-date','event-date','exp-date'].forEach(id => document.getElementById(id).valueAsDate = new Date());

  // ‚îÄ‚îÄ AIRTABLE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function atGet(table) {
    let records = [], offset = null;
    do {
      const url = `${getUrl()}/${encodeURIComponent(table)}` + (offset ? `?offset=${offset}` : '');
      const res  = await fetch(url, { headers: getHeaders() });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      records = records.concat(data.records || []);
      offset  = data.offset || null;
    } while (offset);
    return records;
  }

  async function atCreate(table, fields) {
    const res  = await fetch(`${getUrl()}/${encodeURIComponent(table)}`, {
      method: 'POST', headers: getHeaders(),
      body: JSON.stringify({ records: [{ fields }] })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.records[0];
  }

  async function atDelete(table, atId) {
    await fetch(`${getUrl()}/${encodeURIComponent(table)}/${atId}`, { method: 'DELETE', headers: getHeaders() });
  }

  async function atUpdate(table, atId, fields) {
    const res = await fetch(`${getUrl()}/${encodeURIComponent(table)}/${atId}`, {
      method: 'PATCH', headers: getHeaders(),
      body: JSON.stringify({ fields })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data;
  }

  // ‚îÄ‚îÄ TABLE SCHEMAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Each entry gets an "atId" once it exists in Airtable
  function mileageToFields(e) {
    return { LocalID: String(e.id), Date: e.date, Description: e.desc, Miles: e.miles, Amount: e.amount, Rate: e.rate, Notes: e.note || '' };
  }
  function fieldsToMileage(r) {
    return { id: +r.fields.LocalID, atId: r.id, date: r.fields.Date || '', desc: r.fields.Description || '', miles: r.fields.Miles || 0, amount: r.fields.Amount || 0, rate: r.fields.Rate || IRS_RATE, note: r.fields.Notes || '' };
  }
  function eventToFields(e) {
    return { LocalID: String(e.id), Date: e.date, Sport: e.sport, Home: e.home, Opponent: e.opponent, Venue: e.venue || '', Pay: e.pay, Status: e.status, Notes: e.note || '' };
  }
  function fieldsToEvent(r) {
    return { id: +r.fields.LocalID, atId: r.id, date: r.fields.Date || '', sport: r.fields.Sport || '', home: r.fields.Home || '', opponent: r.fields.Opponent || '', venue: r.fields.Venue || '', pay: r.fields.Pay || 0, status: r.fields.Status || 'pending', note: r.fields.Notes || '' };
  }
  function expenseToFields(e) {
    return { LocalID: String(e.id), Date: e.date, Category: e.category, Description: e.desc, Vendor: e.vendor || '', Amount: e.amount, Notes: e.note || '', Receipt: e.receipt || '' };
  }
  function fieldsToExpense(r) {
    return { id: +r.fields.LocalID, atId: r.id, date: r.fields.Date || '', category: r.fields.Category || 'other', desc: r.fields.Description || '', vendor: r.fields.Vendor || '', amount: r.fields.Amount || 0, note: r.fields.Notes || '', receipt: r.fields.Receipt || null };
  }

  // ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setSyncStatus(state, text) {
    document.getElementById('sync-dot').className = 'sync-dot ' + state;
    document.getElementById('sync-text').textContent = text;
  }

  async function syncAll() {
    setSyncStatus('syncing', 'Syncing...');
    try {
      await Promise.all([syncTable('Mileage', mileageEntries, fieldsToMileage, saveMileage),
                         syncTable('Events',  eventEntries,   fieldsToEvent,   saveEvents),
                         syncTable('Expenses',expenseEntries, fieldsToExpense, saveExpenses)]);
      renderMileage(); renderEvents(); renderExpenses(); updateStats();
      const now = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      setSyncStatus('synced', `Synced ¬∑ ${now}`);
    } catch(err) {
      setSyncStatus('error', 'Sync failed ‚Äî working offline');
      console.error('Sync error:', err);
    }
    hideLoader();
  }

  async function syncTable(table, localArr, fromFields, saveLocal) {
    const remote    = await atGet(table);
    const remoteMap = {};
    remote.forEach(r => { if (r.fields.LocalID) remoteMap[r.fields.LocalID] = r; });

    // Find local entries not yet in Airtable and push them up
    const localMap = {};
    for (const e of localArr) {
      localMap[String(e.id)] = true;
      if (!e.atId && !remoteMap[String(e.id)]) {
        // New local entry ‚Äî create in Airtable
        if (table === 'Mileage') { const r = await atCreate(table, mileageToFields(e)); e.atId = r.id; }
        else if (table === 'Events')  { const r = await atCreate(table, eventToFields(e));   e.atId = r.id; }
        else if (table === 'Expenses'){ const r = await atCreate(table, expenseToFields(e)); e.atId = r.id; }
      } else if (remoteMap[String(e.id)] && !e.atId) {
        e.atId = remoteMap[String(e.id)].id;
      }
    }

    // Pull in remote entries not in local
    for (const r of remote) {
      const lid = r.fields.LocalID;
      if (lid && !localMap[lid]) {
        localArr.unshift(fromFields(r));
      }
    }

    localArr.sort((a,b) => b.id - a.id);
    saveLocal();
  }

  function schedulePush() {
    clearTimeout(syncTimer);
    syncTimer = setTimeout(async () => {
      setSyncStatus('syncing', 'Saving...');
      try {
        await Promise.all([syncTable('Mileage', mileageEntries, fieldsToMileage, saveMileage),
                           syncTable('Events',  eventEntries,   fieldsToEvent,   saveEvents),
                           syncTable('Expenses',expenseEntries, fieldsToExpense, saveExpenses)]);
        const now = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
        setSyncStatus('synced', `Synced ¬∑ ${now}`);
      } catch(err) {
        setSyncStatus('error', 'Saved locally ‚Äî sync failed');
      }
    }, 1200);
  }

  function hideLoader() {
    const ol = document.getElementById('loading-overlay');
    ol.classList.add('hidden');
    setTimeout(() => ol.style.display = 'none', 400);
  }

  // ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function switchTab(tab, btn) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    btn.classList.add('active');
  }

  // ‚îÄ‚îÄ MILEAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcMiles() {
    const start=parseFloat(document.getElementById('start-odo').value), end=parseFloat(document.getElementById('end-odo').value), direct=parseFloat(document.getElementById('direct-miles').value);
    let miles=0;
    if (!isNaN(start)&&!isNaN(end)&&end>start){miles=end-start;document.getElementById('direct-miles').value='';}
    else if(!isNaN(direct)){miles=direct;}
    document.getElementById('calc-miles').textContent=miles.toFixed(1);
    document.getElementById('calc-amount').textContent=(miles*IRS_RATE).toFixed(2);
    document.getElementById('irs-rate-display').textContent=IRS_RATE.toFixed(3);
    return miles;
  }
  document.getElementById('start-odo').addEventListener('input',calcMiles);
  document.getElementById('end-odo').addEventListener('input',calcMiles);
  document.getElementById('direct-miles').addEventListener('input',()=>{document.getElementById('start-odo').value='';document.getElementById('end-odo').value='';calcMiles();});

  function addMileage() {
    const date=document.getElementById('trip-date').value, desc=document.getElementById('trip-desc').value.trim(), miles=calcMiles(), note=document.getElementById('trip-note').value.trim();
    if(!date){showToast('Please add a date');return;} if(!desc){showToast('Please add a description');return;} if(miles<=0){showToast('Please enter mileage');return;}
    const entry={id:Date.now(),date,desc,miles:+miles.toFixed(1),amount:+(miles*IRS_RATE).toFixed(2),rate:IRS_RATE,note};
    mileageEntries.unshift(entry); saveMileage(); renderMileage(); updateStats(); resetMileageForm(); schedulePush(); showToast('‚úì Trip logged!');
  }
  async function deleteMileage(id) {
    const e=mileageEntries.find(e=>e.id===id);
    if(e&&e.atId) { try{await atDelete('Mileage',e.atId);}catch(err){console.error(err);} }
    mileageEntries=mileageEntries.filter(e=>e.id!==id); saveMileage(); renderMileage(); updateStats(); showToast('Trip removed');
  }
  function saveMileage(){localStorage.setItem('mileage_entries',JSON.stringify(mileageEntries));}
  function filteredMileage(){return mileageFilter==='all'?mileageEntries:mileageEntries.filter(e=>e.date.startsWith(mileageFilter));}
  function setMileageFilter(f,el){mileageFilter=f;document.querySelectorAll('#mileage-filters .filter-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderMileage();}
  function renderMileage(){
    const list=document.getElementById('mileage-list'),filtered=filteredMileage();
    if(!filtered.length){list.innerHTML=`<div class="empty-state"><div class="icon">üöó</div><p>No trips logged yet.<br>Add your first trip above!</p></div>`;return;}
    const emojis=['üöó','üèÄ','üèà','‚úàÔ∏è','üõ£Ô∏è','üìç'];
    list.innerHTML=filtered.map(e=>`<div class="entry-card"><div class="entry-dot">${emojis[e.id%emojis.length]}</div><div class="entry-body"><div class="entry-desc">${e.desc}</div><div class="entry-meta">${fmt(e.date)} ¬∑ $${(+e.rate).toFixed(3)}/mi</div>${e.note?`<div class="entry-note">${e.note}</div>`:''}</div><div class="entry-right"><div class="entry-main-val">${e.miles} mi</div><div class="entry-sub-val">$${(+e.amount).toFixed(2)}</div></div><button class="entry-delete" onclick="deleteMileage(${e.id})">‚úï</button></div>`).join('');
  }
  function resetMileageForm(){['trip-desc','start-odo','end-odo','direct-miles','trip-note'].forEach(id=>document.getElementById(id).value='');document.getElementById('calc-miles').textContent='0';document.getElementById('calc-amount').textContent='0.00';document.getElementById('trip-date').valueAsDate=new Date();}
  function exportMileageCSV(){if(!mileageEntries.length){showToast('No trips to export');return;}const rows=[['Date','Description','Miles','Rate','Amount','Notes']];mileageEntries.forEach(e=>rows.push([e.date,`"${e.desc}"`,e.miles,e.rate,e.amount,`"${e.note}"`]));dlCSV(rows,`mileage_log_${today()}.csv`);showToast('CSV downloaded!');}

  // ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updatePayDisplay(){document.getElementById('display-pay').textContent=(parseFloat(document.getElementById('event-pay').value)||0).toFixed(2);}
  function addEvent(){
    const date=document.getElementById('event-date').value,sport=document.getElementById('event-sport').value,home=document.getElementById('event-home').value.trim()||'Utah State',opponent=document.getElementById('event-opponent').value.trim(),venue=document.getElementById('event-venue').value.trim(),pay=parseFloat(document.getElementById('event-pay').value)||0,status=document.getElementById('event-status').value,note=document.getElementById('event-note').value.trim();
    if(!date){showToast('Please add a date');return;}if(!opponent){showToast('Please add an opponent');return;}
    const entry={id:Date.now(),date,sport,home,opponent,venue,pay,status,note};
    eventEntries.unshift(entry);saveEvents();renderEvents();updateStats();resetEventForm();schedulePush();showToast('‚úì Event logged!');
  }
  async function deleteEvent(id){
    const e=eventEntries.find(e=>e.id===id);
    if(e&&e.atId){try{await atDelete('Events',e.atId);}catch(err){console.error(err);}}
    eventEntries=eventEntries.filter(e=>e.id!==id);saveEvents();renderEvents();updateStats();showToast('Event removed');
  }
  async function cycleStatus(id){
    const cycle={pending:'invoiced',invoiced:'paid',paid:'pending'};
    const e=eventEntries.find(e=>e.id==id);
    if(e){e.status=cycle[e.status]||'pending';saveEvents();renderEvents();showToast('Status updated');if(e.atId){try{await atUpdate('Events',e.atId,{Status:e.status});}catch(err){schedulePush();}}}
  }
  function saveEvents(){localStorage.setItem('event_entries',JSON.stringify(eventEntries));}
  function filteredEvents(){if(eventFilter==='all')return eventEntries;if(['2025','2026'].includes(eventFilter))return eventEntries.filter(e=>e.date.startsWith(eventFilter));if(['Basketball','Football','Other'].includes(eventFilter))return eventEntries.filter(e=>e.sport===eventFilter);return eventEntries.filter(e=>e.status===eventFilter);}
  function setEventFilter(f,el){eventFilter=f;document.querySelectorAll('#event-filters .filter-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderEvents();}
  const sportEmoji={Basketball:'üèÄ',Football:'üèà',Other:'üéôÔ∏è'};
  const statusLabel={pending:'Pending',invoiced:'Invoiced',paid:'Paid'};
  function renderEvents(){
    const list=document.getElementById('events-list'),filtered=filteredEvents();
    if(!filtered.length){list.innerHTML=`<div class="empty-state"><div class="icon">üéôÔ∏è</div><p>No events logged yet.<br>Add your first broadcast above!</p></div>`;return;}
    list.innerHTML=filtered.map(e=>`<div class="entry-card"><div class="entry-dot">${sportEmoji[e.sport]||'üéôÔ∏è'}</div><div class="entry-body"><div class="entry-desc">${e.home} vs. ${e.opponent}</div><div class="entry-meta">${fmt(e.date)}${e.venue?' ¬∑ '+e.venue:''}</div><div class="entry-badges"><span class="sport-badge sport-${e.sport.toLowerCase()}">${e.sport}</span><span class="status-badge status-${e.status}" onclick="cycleStatus(${e.id})">${statusLabel[e.status]}</span></div>${e.note?`<div class="entry-note">${e.note}</div>`:''}</div><div class="entry-right"><div class="entry-main-val">$${(+e.pay).toFixed(2)}</div></div><button class="entry-delete" onclick="deleteEvent(${e.id})">‚úï</button></div>`).join('');
  }
  function resetEventForm(){['event-home','event-opponent','event-venue','event-pay','event-note'].forEach(id=>document.getElementById(id).value='');document.getElementById('event-sport').value='Basketball';document.getElementById('event-status').value='pending';document.getElementById('display-pay').textContent='0.00';document.getElementById('event-date').valueAsDate=new Date();}
  function exportEventsCSV(){if(!eventEntries.length){showToast('No events to export');return;}const rows=[['Date','Sport','Home','Opponent','Venue','Pay','Status','Notes']];eventEntries.forEach(e=>rows.push([e.date,e.sport,`"${e.home}"`,`"${e.opponent}"`,`"${e.venue}"`,e.pay,e.status,`"${e.note}"`]));dlCSV(rows,`event_log_${today()}.csv`);showToast('CSV downloaded!');}

  // ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const catEmoji={meals:'üçî',transport:'üöï',lodging:'üè®',equipment:'üéß',other:'üìé'};
  const catLabel={meals:'Meals',transport:'Transport',lodging:'Lodging',equipment:'Equipment',other:'Other'};
  function updateExpDisplay(){document.getElementById('display-exp').textContent=(parseFloat(document.getElementById('exp-amount').value)||0).toFixed(2);}
  function handleReceiptUpload(e){const file=e.target.files[0];if(!file)return;if(file.size>4*1024*1024){showToast('Image too large ‚Äî try a smaller photo');return;}const reader=new FileReader();reader.onload=(ev)=>{pendingReceipt=ev.target.result;document.getElementById('receipt-preview-container').innerHTML=`<div class="receipt-preview"><img src="${pendingReceipt}" alt="Receipt preview"><button class="remove-receipt" onclick="clearReceipt()">‚úï</button></div>`;document.getElementById('upload-area').style.display='none';};reader.readAsDataURL(file);}
  function clearReceipt(){pendingReceipt=null;document.getElementById('receipt-preview-container').innerHTML='';document.getElementById('receipt-input').value='';document.getElementById('upload-area').style.display='block';}
  function addExpense(){
    const date=document.getElementById('exp-date').value,category=document.getElementById('exp-category').value,desc=document.getElementById('exp-desc').value.trim(),amount=parseFloat(document.getElementById('exp-amount').value)||0,vendor=document.getElementById('exp-vendor').value.trim(),note=document.getElementById('exp-note').value.trim();
    if(!date){showToast('Please add a date');return;}if(!desc){showToast('Please add a description');return;}if(amount<=0){showToast('Please enter an amount');return;}
    const entry={id:Date.now(),date,category,desc,amount,vendor,note,receipt:pendingReceipt};
    expenseEntries.unshift(entry);saveExpenses();renderExpenses();updateStats();resetExpenseForm();schedulePush();showToast('‚úì Expense logged!');
  }
  async function deleteExpense(id){
    const e=expenseEntries.find(e=>e.id===id);
    if(e&&e.atId){try{await atDelete('Expenses',e.atId);}catch(err){console.error(err);}}
    expenseEntries=expenseEntries.filter(e=>e.id!==id);saveExpenses();renderExpenses();updateStats();showToast('Expense removed');
  }
  function saveExpenses(){localStorage.setItem('expense_entries',JSON.stringify(expenseEntries));}
  function filteredExpenses(){if(expenseFilter==='all')return expenseEntries;if(['2025','2026'].includes(expenseFilter))return expenseEntries.filter(e=>e.date.startsWith(expenseFilter));return expenseEntries.filter(e=>e.category===expenseFilter);}
  function setExpenseFilter(f,el){expenseFilter=f;document.querySelectorAll('#expense-filters .filter-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderExpenses();}
  function renderExpenses(){
    const list=document.getElementById('expenses-list'),filtered=filteredExpenses();
    if(!filtered.length){list.innerHTML=`<div class="empty-state"><div class="icon">üßæ</div><p>No expenses logged yet.<br>Add your first expense above!</p></div>`;return;}
    const total=filtered.reduce((s,e)=>s+(+e.amount),0);
    list.innerHTML=filtered.map(e=>`<div class="entry-card"><div class="entry-dot">${catEmoji[e.category]||'üìé'}</div><div class="entry-body"><div class="entry-desc">${e.desc}</div><div class="entry-meta">${fmt(e.date)}${e.vendor?' ¬∑ '+e.vendor:''}</div><div class="entry-badges"><span class="cat-badge cat-${e.category}">${catLabel[e.category]}</span></div>${e.note?`<div class="entry-note">${e.note}</div>`:''}</div><div class="entry-right"><div class="entry-main-val">$${(+e.amount).toFixed(2)}</div>${e.receipt?`<img class="receipt-thumb" src="${e.receipt}" alt="Receipt" onclick="openLightbox(${e.id})">`:`<div class="no-receipt">üìÑ</div>`}</div><button class="entry-delete" onclick="deleteExpense(${e.id})">‚úï</button></div>`).join('')+`<div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--navy);text-align:right;padding:8px 4px 0;font-weight:500;">Showing total: $${total.toFixed(2)}</div>`;
  }
  function resetExpenseForm(){['exp-desc','exp-amount','exp-vendor','exp-note'].forEach(id=>document.getElementById(id).value='');document.getElementById('exp-category').value='meals';document.getElementById('display-exp').textContent='0.00';document.getElementById('exp-date').valueAsDate=new Date();clearReceipt();}
  function exportExpensesCSV(){if(!expenseEntries.length){showToast('No expenses to export');return;}const rows=[['Date','Category','Description','Vendor','Amount','Notes','Has Receipt']];expenseEntries.forEach(e=>rows.push([e.date,e.category,`"${e.desc}"`,`"${e.vendor}"`,e.amount,`"${e.note}"`,e.receipt?'Yes':'No']));dlCSV(rows,`expense_log_${today()}.csv`);showToast('CSV downloaded!');}

  // ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openLightbox(id){const e=expenseEntries.find(e=>e.id==id);if(!e||!e.receipt)return;document.getElementById('lightbox-img').src=e.receipt;document.getElementById('lightbox').classList.add('open');}
  function closeLightbox(){document.getElementById('lightbox').classList.remove('open');}

  // ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateStats(){
    document.getElementById('ytd-miles').textContent=mileageEntries.reduce((s,e)=>s+(+e.miles),0).toFixed(0);
    document.getElementById('ytd-events').textContent=eventEntries.length;
    const exp=expenseEntries.reduce((s,e)=>s+(+e.amount),0);
    document.getElementById('ytd-expenses').textContent='$'+(exp>=1000?(exp/1000).toFixed(1)+'k':exp.toFixed(0));
  }

  // ‚îÄ‚îÄ EXPORT ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportAllCSV(){
    if(!mileageEntries.length&&!eventEntries.length&&!expenseEntries.length){showToast('Nothing to export yet');return;}
    const ts=new Date().toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
    const lines=[`"SCOTT GARRARD ‚Äî BROADCAST TRACKER BACKUP"`,`"Generated: ${ts}"`,''
    ,'"=== MILEAGE LOG ==="',['Date','Description','Miles','Rate','Reimbursement','Notes'].join(',')];
    mileageEntries.forEach(e=>lines.push([e.date,`"${e.desc}"`,e.miles,e.rate,e.amount,`"${e.note}"`].join(',')));
    lines.push(['"TOTAL"','',mileageEntries.reduce((s,e)=>s+(+e.miles),0).toFixed(1),'',mileageEntries.reduce((s,e)=>s+(+e.amount),0).toFixed(2),''].join(','),'');
    lines.push('"=== EVENT LOG ==="',['Date','Sport','Home','Opponent','Venue','Pay','Status','Notes'].join(','));
    eventEntries.forEach(e=>lines.push([e.date,e.sport,`"${e.home}"`,`"${e.opponent}"`,`"${e.venue}"`,e.pay,e.status,`"${e.note}"`].join(',')));
    lines.push(['"TOTAL"','','','','',eventEntries.reduce((s,e)=>s+(+e.pay),0).toFixed(2),'',''].join(','),'');
    lines.push('"=== EXPENSE LOG ==="',['Date','Category','Description','Vendor','Amount','Notes','Has Receipt'].join(','));
    expenseEntries.forEach(e=>lines.push([e.date,e.category,`"${e.desc}"`,`"${e.vendor}"`,e.amount,`"${e.note}"`,e.receipt?'Yes':'No'].join(',')));
    lines.push(['"TOTAL"','','','',expenseEntries.reduce((s,e)=>s+(+e.amount),0).toFixed(2),'',''].join(','),'');
    lines.push('"=== SUMMARY ==="',['Category','Value'].join(','),
      ['"Total Miles"',mileageEntries.reduce((s,e)=>s+(+e.miles),0).toFixed(1)].join(','),
      ['"Mileage Reimbursement"','$'+mileageEntries.reduce((s,e)=>s+(+e.amount),0).toFixed(2)].join(','),
      ['"Events Called"',eventEntries.length].join(','),
      ['"Total Event Pay"','$'+eventEntries.reduce((s,e)=>s+(+e.pay),0).toFixed(2)].join(','),
      ['"Total Expenses"','$'+expenseEntries.reduce((s,e)=>s+(+e.amount),0).toFixed(2)].join(','));
    Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/csv'})),download:`broadcast_tracker_backup_${today()}.csv`}).click();
    showToast('üíæ Full backup downloaded!');
  }

  // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function fmt(d){return new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
  function today(){return new Date().toISOString().slice(0,10);}
  function dlCSV(rows,filename){Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'})),download:filename}).click();}
  function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderMileage(); renderEvents(); renderExpenses(); updateStats();
  syncAll(); // Pull latest from Airtable on load
</script>
</body>
</html>
